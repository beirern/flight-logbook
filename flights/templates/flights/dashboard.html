{% extends "flights/base.html" %}

{% block title %}Dashboard - Flight Logbook{% endblock %}

{% block nav_dashboard %}active{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Flight Dashboard</h1>
        {% if is_static and last_updated %}
        <small class="text-muted">Last updated: {{ last_updated }}Z</small>
        {% endif %}
    </div>

    <!-- Hero Stats Section -->
    <div class="row mb-4">
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Total Time</h6>
                    <h2 class="card-title">{{ total_times.total_time|floatformat:1 }}</h2>
                    <p class="card-text">hours</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">PIC Time</h6>
                    <h2 class="card-title">{{ total_times.pic_time|floatformat:1 }}</h2>
                    <p class="card-text">hours</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Instrument Time</h6>
                    <h2 class="card-title">{{ instrument_breakdown.total|floatformat:1 }}</h2>
                    <p class="card-text">hours</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Cross Country</h6>
                    <h2 class="card-title">{{ total_times.xc_time|floatformat:1 }}</h2>
                    <p class="card-text">hours</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Total Landings</h6>
                    <h2 class="card-title">{{ total_times.total_landings }}</h2>
                    <p class="card-text">landings</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Days Since Last Flight</h6>
                    <h2 class="card-title">{{ days_since_last_flight|default:"N/A" }}</h2>
                    <p class="card-text">days</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Currency Tracking Section -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5>Passenger Currency (¬ßFAR 61.57a)</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Day Currency (90 days)</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge {% if currency.day_current %}bg-success{% else %}bg-danger{% endif %}">
                                    {% if currency.day_current %}CURRENT{% else %}NOT CURRENT{% endif %}
                                </span>
                                <span class="ms-2">{{ currency.day_landings }}/3 landings</span>
                            </div>
                            {% if currency.day_expiry %}
                                <small class="text-muted">Expires: {{ currency.day_expiry }}</small>
                            {% endif %}
                        </div>
                        <div class="progress mt-2" style="height: 25px;">
                            <div class="progress-bar {% if currency.day_current %}bg-success{% else %}bg-danger{% endif %}"
                                 role="progressbar"
                                 style="width: {% widthratio currency.day_landings 3 100 %}%">
                                {{ currency.day_landings }}/3
                            </div>
                        </div>
                    </div>
                    <div>
                        <h6>Night Currency (90 days)</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge {% if currency.night_current %}bg-success{% else %}bg-danger{% endif %}">
                                    {% if currency.night_current %}CURRENT{% else %}NOT CURRENT{% endif %}
                                </span>
                                <span class="ms-2">{{ currency.night_landings }}/3 landings</span>
                            </div>
                            {% if currency.night_expiry %}
                                <small class="text-muted">Expires: {{ currency.night_expiry }}</small>
                            {% endif %}
                        </div>
                        <div class="progress mt-2" style="height: 25px;">
                            <div class="progress-bar {% if currency.night_current %}bg-success{% else %}bg-danger{% endif %}"
                                 role="progressbar"
                                 style="width: {% widthratio currency.night_landings 3 100 %}%">
                                {{ currency.night_landings }}/3
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5>Medical Certificate</h5>
                </div>
                <div class="card-body">
                    {% if medical.has_medical %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6>Class {{ medical.class }} Medical</h6>
                            <span class="badge
                                {% if medical.status == 'current' %}bg-success
                                {% elif medical.status == 'warning' %}bg-warning
                                {% elif medical.status == 'critical' %}bg-danger
                                {% else %}bg-secondary{% endif %}">
                                {{ medical.status|upper }}
                            </span>
                        </div>
                        <p class="mb-1"><strong>Expires:</strong> {{ medical.expiry }}</p>
                        <p class="mb-0">
                            <strong>Days Remaining:</strong>
                            <span class="{% if medical.days_remaining < 30 %}text-danger{% elif medical.days_remaining < 60 %}text-warning{% else %}text-success{% endif %}">
                                {{ medical.days_remaining }} days
                            </span>
                        </p>
                    {% else %}
                        <p class="text-muted">No medical certificate on file</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Instrument Rating Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5>Instrument Rating Progress (¬ßFAR 61.65d)</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Instrument Time</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{ ir_progress.creditable_total }}/40 hours</span>
                                <span class="badge bg-success">{{ ir_progress.percentage|floatformat:1 }}% Complete</span>
                            </div>
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar bg-success"
                                     role="progressbar"
                                     style="width: {{ ir_progress.percentage }}%">
                                    {{ ir_progress.creditable_total }}/40 hrs
                                </div>
                            </div>
                            <small class="text-muted">Remaining: {{ ir_progress.remaining|floatformat:1 }} hrs</small>
                        </div>
                        <div class="col-md-6">
                            <h6>Cross Country PIC Time</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{ ir_progress.xc_pic_time|floatformat:1 }}/{{ ir_progress.xc_pic_required }} hours</span>
                                <span class="badge bg-success">{{ ir_progress.xc_pic_percentage|floatformat:1 }}% Complete</span>
                            </div>
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar bg-success"
                                     role="progressbar"
                                     style="width: {{ ir_progress.xc_pic_percentage }}%">
                                    {{ ir_progress.xc_pic_time|floatformat:1 }}/{{ ir_progress.xc_pic_required }} hrs
                                </div>
                            </div>
                            <small class="text-muted">Remaining: {{ ir_progress.xc_pic_remaining|floatformat:1 }} hrs</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Actual Instrument:</strong> {{ ir_progress.actual|floatformat:1 }} hrs
                        </div>
                        <div class="col-md-3">
                            <strong>Simulated:</strong> {{ ir_progress.simulated|floatformat:1 }} hrs
                        </div>
                        <div class="col-md-3">
                            <strong>Creditable Simulated:</strong> {{ ir_progress.creditable_simulated|floatformat:1 }} hrs (max 20)
                        </div>
                        <div class="col-md-3">
                            <strong>Total Instrument:</strong> {{ ir_progress.creditable_total|floatformat:1 }} hrs
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Commercial License Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5>Commercial Pilot License Progress (¬ßFAR 61.129)</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <h6>Total Flight Time</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{ commercial_progress.total_time.current|floatformat:1 }}/{{ commercial_progress.total_time.required }} hours</span>
                                <span class="badge bg-warning text-dark">{{ commercial_progress.total_time.percentage|floatformat:1 }}%</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-warning"
                                     role="progressbar"
                                     style="width: {{ commercial_progress.total_time.percentage }}%">
                                    {{ commercial_progress.total_time.current|floatformat:1 }}/{{ commercial_progress.total_time.required }}
                                </div>
                            </div>
                            <small class="text-muted">Remaining: {{ commercial_progress.total_time.remaining|floatformat:1 }} hrs</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <h6>PIC Time</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{ commercial_progress.pic_time.current|floatformat:1 }}/{{ commercial_progress.pic_time.required }} hours</span>
                                <span class="badge bg-warning text-dark">{{ commercial_progress.pic_time.percentage|floatformat:1 }}%</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-warning"
                                     role="progressbar"
                                     style="width: {{ commercial_progress.pic_time.percentage }}%">
                                    {{ commercial_progress.pic_time.current|floatformat:1 }}/{{ commercial_progress.pic_time.required }}
                                </div>
                            </div>
                            <small class="text-muted">Remaining: {{ commercial_progress.pic_time.remaining|floatformat:1 }} hrs</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <h6>Cross Country PIC Time</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{ commercial_progress.xc_pic_time.current|floatformat:1 }}/{{ commercial_progress.xc_pic_time.required }} hours</span>
                                <span class="badge bg-warning text-dark">{{ commercial_progress.xc_pic_time.percentage|floatformat:1 }}%</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-warning"
                                     role="progressbar"
                                     style="width: {{ commercial_progress.xc_pic_time.percentage }}%">
                                    {{ commercial_progress.xc_pic_time.current|floatformat:1 }}/{{ commercial_progress.xc_pic_time.required }}
                                </div>
                            </div>
                            <small class="text-muted">Remaining: {{ commercial_progress.xc_pic_time.remaining|floatformat:1 }} hrs</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboards Section -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5>Passenger Leaderboard</h5>
                </div>
                <div class="card-body">
                    {% if passenger_leaderboard %}
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>Flights</th>
                                    <th>Total Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in passenger_leaderboard %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ entry.pilot.first_name }}</td>
                                    <td>{{ entry.flight_count }}</td>
                                    <td>{{ entry.total_time }} hrs</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">No passengers recorded yet</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5>Instructor Leaderboard</h5>
                </div>
                <div class="card-body">
                    {% if instructor_leaderboard %}
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>Flights</th>
                                    <th>Total Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in instructor_leaderboard %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ entry.pilot.first_name }}</td>
                                    <td>{{ entry.flight_count }}</td>
                                    <td>{{ entry.total_time }} hrs</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">No instructors recorded yet</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Cumulative Time Progression</h5>
                </div>
                <div class="card-body">
                    <canvas id="cumulativeChart"></canvas>
                    <div class="mt-3">
                        <h6>Milestones:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small>
                                    <ul class="list-unstyled" style="font-size: 0.85rem;">
                                        <li><span style="color: rgba(128, 128, 128, 0.8);">‚óè</span> 2021-04-05: First Discovery Flight</li>
                                        <li><span style="color: rgba(128, 128, 128, 0.8);">‚óè</span> 2023-08-16: Second Discovery Flight</li>
                                        <li><span style="color: rgba(54, 162, 235, 0.8);">‚óè</span> 2024-07-31: Stage Check 1 PPL</li>
                                        <li><span style="color: rgba(255, 206, 86, 0.8);">‚óè</span> 2024-08-12: First Solo C162</li>
                                        <li><span style="color: rgba(153, 102, 255, 0.8);">‚óè</span> 2025-01-25: KSQL</li>
                                        <li><span style="color: rgba(75, 192, 192, 0.8);">‚óè</span> 2025-07-27: Return to RFS</li>
                                    </ul>
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small>
                                    <ul class="list-unstyled" style="font-size: 0.85rem;">
                                        <li><span style="color: rgba(255, 99, 132, 0.8);">‚óè</span> 2025-08-19: Stage 2 Check PPL Fail</li>
                                        <li><span style="color: rgba(0, 200, 0, 0.8);">‚óè</span> 2025-09-16: Stage 2 Check PPL Pass</li>
                                        <li><span style="color: rgba(255, 159, 64, 0.8);">‚óè</span> 2025-09-19: Second Solo C172</li>
                                        <li><span style="color: rgba(100, 100, 100, 0.8);">‚óè</span> 2025-09-22: First XC Solo</li>
                                        <li><span style="color: rgba(0, 128, 0, 0.8);">‚óè</span> 2025-10-30: EOC PPL Pass</li>
                                        <li><span style="color: rgba(0, 100, 0, 0.9);">‚óè</span> 2025-12-01: PPL Checkride</li>
                                    </ul>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5>Monthly Flight Activity (Last 12 Months)</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5>Instrument Time Breakdown</h5>
                </div>
                <div class="card-body">
                    <canvas id="instrumentChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Aircraft Breakdown -->
    {% if aircraft_breakdown %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Aircraft Experience</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Aircraft</th>
                                <th>Type</th>
                                <th>Total Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for aircraft in aircraft_breakdown %}
                            <tr>
                                <td>{{ aircraft.tail_number }}</td>
                                <td>{{ aircraft.type }}</td>
                                <td>{{ aircraft.hours|floatformat:1 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Flights -->
    {% if recent_flights %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Recent Flights</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Aircraft</th>
                                <th>Duration</th>
                                <th>Day Landings</th>
                                <th>Night Landings</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for flight in recent_flights %}
                            <tr>
                                <td>{{ flight.date }}</td>
                                <td>{{ flight.plane }}</td>
                                <td>{{ flight.flight_time|floatformat:1 }}</td>
                                <td>{{ flight.total_day_landings }}</td>
                                <td>{{ flight.total_night_landings }}</td>
                                <td>{{ flight.notes|truncatewords:10 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Monthly Activity Chart
    const monthlyCtx = document.getElementById('monthlyChart');
    new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: {{ monthly_labels|safe }},
            datasets: [{
                label: 'Flight Hours',
                data: {{ monthly_hours|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Hours'
                    }
                }
            }
        }
    });

    // Instrument Time Breakdown Chart
    const instrumentCtx = document.getElementById('instrumentChart');
    new Chart(instrumentCtx, {
        type: 'pie',
        data: {
            labels: ['Actual Instrument', 'Simulated Instrument'],
            datasets: [{
                data: [{{ instrument_breakdown.actual }}, {{ instrument_breakdown.simulated }}],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Cumulative Time Progression Chart
    const cumulativeCtx = document.getElementById('cumulativeChart');
    const cumulativeData = {{ cumulative_data|safe }};

    new Chart(cumulativeCtx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Total Time',
                    data: cumulativeData.map(d => ({x: d.date, y: d.total})),
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: false,
                    tension: 0.1
                },
                {
                    label: 'PIC Time',
                    data: cumulativeData.map(d => ({x: d.date, y: d.pic})),
                    borderColor: 'rgba(255, 159, 64, 1)',
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    fill: false,
                    tension: 0.1
                },
                {
                    label: 'Dual Instruction',
                    data: cumulativeData.map(d => ({x: d.date, y: d.dual})),
                    borderColor: 'rgba(153, 102, 255, 1)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    fill: false,
                    tension: 0.1
                },
                {
                    label: 'Instrument Time',
                    data: cumulativeData.map(d => ({x: d.date, y: d.instrument})),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: false,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Cumulative Hours'
                    }
                },
                x: {
                    type: 'time',
                    time: {
                        unit: 'month',
                        displayFormats: {
                            month: 'MMM yyyy'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        afterBody: function(context) {
                            if (context.length === 0) return '';
                            const date = context[0].parsed.x;
                            const dateStr = new Date(date).toISOString().split('T')[0];

                            const milestones = {
                                '2021-04-05': 'First Discovery Flight',
                                '2023-08-16': 'Second Discovery Flight',
                                '2024-07-31': 'Stage Check 1 PPL',
                                '2024-08-12': 'First Solo C162',
                                '2025-01-25': 'KSQL',
                                '2025-07-27': 'Return to RFS',
                                '2025-08-19': 'Stage 2 Check PPL Fail',
                                '2025-09-16': 'Stage 2 Check PPL Pass',
                                '2025-09-19': 'Second Solo C172',
                                '2025-09-22': 'First XC Solo',
                                '2025-10-30': 'EOC PPL Pass',
                                '2025-12-01': 'PPL Checkride'
                            };

                            if (milestones[dateStr]) {
                                return '\nüéØ ' + milestones[dateStr];
                            }
                            return '';
                        }
                    }
                },
                annotation: {
                    annotations: {
                        discovery1: {
                            type: 'line',
                            xMin: '2021-04-05',
                            xMax: '2021-04-05',
                            borderColor: 'rgba(128, 128, 128, 0.6)',
                            borderWidth: 2,
                            borderDash: [3, 3],
                            label: {
                                display: true,
                                content: 'First Discovery Flight',
                                position: 'start',
                                yAdjust: -10,
                                backgroundColor: 'rgba(128, 128, 128, 0.8)',
                                color: 'white',
                                font: {
                                    size: 10
                                },
                                padding: 3
                            }
                        },
                        discovery2: {
                            type: 'line',
                            xMin: '2023-08-16',
                            xMax: '2023-08-16',
                            borderColor: 'rgba(128, 128, 128, 0.6)',
                            borderWidth: 2,
                            borderDash: [3, 3],
                            label: {
                                display: true,
                                content: 'Second Discovery Flight',
                                position: 'start',
                                yAdjust: -10,
                                backgroundColor: 'rgba(128, 128, 128, 0.8)',
                                color: 'white',
                                font: {
                                    size: 10
                                },
                                padding: 3
                            }
                        },
                        stage1: {
                            type: 'line',
                            xMin: '2024-07-31',
                            xMax: '2024-07-31',
                            borderColor: 'rgba(54, 162, 235, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                display: false
                            }
                        },
                        firstSolo: {
                            type: 'line',
                            xMin: '2024-08-12',
                            xMax: '2024-08-12',
                            borderColor: 'rgba(255, 206, 86, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                display: true,
                                content: 'First Solo C162',
                                position: 'start',
                                yAdjust: -10,
                                backgroundColor: 'rgba(255, 206, 86, 0.8)',
                                color: 'black',
                                font: {
                                    weight: 'bold',
                                    size: 10
                                },
                                padding: 3
                            }
                        },
                        ksql: {
                            type: 'line',
                            xMin: '2025-01-25',
                            xMax: '2025-01-25',
                            borderColor: 'rgba(153, 102, 255, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                display: true,
                                content: 'KSQL',
                                position: 'start',
                                yAdjust: -10,
                                backgroundColor: 'rgba(153, 102, 255, 0.8)',
                                color: 'white',
                                font: {
                                    weight: 'bold',
                                    size: 10
                                },
                                padding: 3
                            }
                        },
                        returnRFS: {
                            type: 'line',
                            xMin: '2025-07-27',
                            xMax: '2025-07-27',
                            borderColor: 'rgba(75, 192, 192, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                display: true,
                                content: 'RFS',
                                position: 'start',
                                yAdjust: -10,
                                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                                color: 'white',
                                font: {
                                    weight: 'bold',
                                    size: 10
                                },
                                padding: 3
                            }
                        },
                        stage2Fail: {
                            type: 'line',
                            xMin: '2025-08-19',
                            xMax: '2025-08-19',
                            borderColor: 'rgba(255, 99, 132, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                display: false
                            }
                        },
                        stage2Pass: {
                            type: 'line',
                            xMin: '2025-09-16',
                            xMax: '2025-09-16',
                            borderColor: 'rgba(0, 200, 0, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                display: false
                            }
                        },
                        secondSolo: {
                            type: 'line',
                            xMin: '2025-09-19',
                            xMax: '2025-09-19',
                            borderColor: 'rgba(255, 159, 64, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                display: false
                            }
                        },
                        firstXC: {
                            type: 'line',
                            xMin: '2025-09-22',
                            xMax: '2025-09-22',
                            borderColor: 'rgba(201, 203, 207, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                display: false
                            }
                        },
                        eoc: {
                            type: 'line',
                            xMin: '2025-10-30',
                            xMax: '2025-10-30',
                            borderColor: 'rgba(0, 128, 0, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                display: false
                            }
                        },
                        pplCheckride: {
                            type: 'line',
                            xMin: '2025-12-01',
                            xMax: '2025-12-01',
                            borderColor: 'rgba(0, 100, 0, 0.9)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            label: {
                                display: true,
                                content: 'PPL Checkride',
                                position: 'start',
                                yAdjust: -10,
                                backgroundColor: 'rgba(0, 100, 0, 0.9)',
                                color: 'white',
                                font: {
                                    weight: 'bold',
                                    size: 11
                                },
                                padding: 4
                            }
                        }
                    }
                }
            }
        }
    });

    // Client-side currency recalculation for static sites
    {% if is_static %}
    async function recalculateCurrency() {
        try {
            // Load flight data
            const response = await fetch('data/flights.json');
            const flights = await response.json();

            const today = new Date();
            const ninetyDaysAgo = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));

            // Calculate day and night landings in the last 90 days
            let dayLandings = 0;
            let nightFullstopLandings = 0;

            flights.forEach(flight => {
                const flightDate = new Date(flight.date);
                if (flightDate >= ninetyDaysAgo) {
                    dayLandings += flight.day_landings;
                    nightFullstopLandings += flight.night_fullstop_landings;
                }
            });

            // Update day currency display
            const dayCurrent = dayLandings >= 3;
            const dayBadge = document.querySelector('.badge.bg-success, .badge.bg-danger');
            if (dayBadge && dayBadge.textContent.includes('CURRENT')) {
                dayBadge.textContent = dayCurrent ? 'CURRENT' : 'NOT CURRENT';
                dayBadge.className = dayCurrent ? 'badge bg-success' : 'badge bg-danger';
            }

            // Update night currency display
            const nightCurrent = nightFullstopLandings >= 3;
            const nightBadges = document.querySelectorAll('.badge');
            nightBadges.forEach(badge => {
                if (badge.textContent.includes('CURRENT') && badge.closest('div').querySelector('h6')?.textContent.includes('Night')) {
                    badge.textContent = nightCurrent ? 'CURRENT' : 'NOT CURRENT';
                    badge.className = nightCurrent ? 'badge bg-success' : 'badge bg-danger';
                }
            });

            // Calculate days since last flight
            if (flights.length > 0) {
                const lastFlight = new Date(flights[0].date);
                const daysSince = Math.floor((today - lastFlight) / (24 * 60 * 60 * 1000));

                const daysSinceElement = document.querySelector('.card-title');
                if (daysSinceElement && daysSinceElement.parentElement.querySelector('.card-subtitle').textContent.includes('Days Since')) {
                    daysSinceElement.textContent = daysSince;
                }
            }
        } catch (error) {
            console.error('Error recalculating currency:', error);
        }
    }

    // Run on page load
    recalculateCurrency();
    {% endif %}
</script>
{% endblock %}
